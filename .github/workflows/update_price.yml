name: Update Silver Price

on:
  schedule:
    - cron: '0 6 * * *' # Runs at 06:00 UTC every day
  workflow_dispatch: # Allows manual trigger

jobs:
  update-price:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch Silver Price
        env:
          GOLD_API_KEY: ${{ secrets.GOLD_API_KEY }}
        run: |
          # 1. Fetch Silver Price in USD (XAG/USD)
          echo "Fetching Silver Price (USD)..."
          silver_response=$(curl -s -H "x-access-token: $GOLD_API_KEY" "https://www.goldapi.io/api/XAG/USD")
          
          # Extract price using jq
          silver_price_usd=$(echo "$silver_response" | jq -r '.price')
          
          if [ "$silver_price_usd" == "null" ] || [ -z "$silver_price_usd" ]; then
            echo "Failed to fetch Silver Price (USD)"
            echo "$silver_response"
            exit 1
          fi
          echo "Silver Price (USD): $silver_price_usd"

          # 2. Fetch USD to BDT Exchange Rate (Free Public API)
          echo "Fetching USD to BDT Rate..."
          currency_response=$(curl -s "https://open.er-api.com/v6/latest/USD")
          usd_to_bdt=$(echo "$currency_response" | jq -r '.rates.BDT')

          if [ "$usd_to_bdt" == "null" ] || [ -z "$usd_to_bdt" ]; then
            echo "Failed to fetch USD/BDT rate, using fallback 120.0"
            usd_to_bdt=120.0
          fi
          echo "USD to BDT Rate: $usd_to_bdt"

          # 3. Calculate Price in BDT
          price_bdt=$(echo "$silver_price_usd * $usd_to_bdt" | bc)
          echo "Calculated Silver Price (BDT): $price_bdt"

          # 4. Create JSON Output
          timestamp=$(date +%s)
          
          # Construct JSON manually to ensure correct format
          echo "{
            \"timestamp\": $timestamp,
            \"metal\": \"XAG\",
            \"currency\": \"BDT\",
            \"price\": $price_bdt,
            \"rate_usd\": $silver_price_usd,
            \"exchange_rate\": $usd_to_bdt
          }" > price.json
          
          cat price.json

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update silver price [skip ci]"
          file_pattern: price.json
